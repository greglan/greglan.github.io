---
layout: page
title:  "Heap exploitation"
permalink: "heap-exploitation.html"
tags: [security, exploitation]
summary: "Some notes about exploiting the heap"
---

## Basic heap overflows
This section is based on the
[Once upon a free() article](http://phrack.org/issues/57/9.html). A good
understanding of the [chunk structures](/glibc-heaps.html#chunk-metada) is
required. We consider two chunks a and b where we can overflow the chunk a.

![setup](/images/heap-overflow-setup.png)

* `unlink()` macro used to remove an element from the doubly linked list of free chunks

```C
#define unlink(P, BK, FD)   \
{
    BK = P->bk;             \
    FD = P->fd;             \
    FD->bk = BK;            \   // *(next->fd + 12) = next->bk;
    BK->fd = FD;            \   // *(next->bk + 8) = next->fd;
}
```
* When chunk a is overflowed, it is possible to call this macro with controlled
  parameters (members of chunk b). Since this functions performs memory writes,
  we have an arbitrary write primitive.
* We use the first write (`(next->fd + 12) = next->bk`) to overwrite the value of
  the return address (`retaddr`) which is saved at `retloc`.

  Hence we need `*(retloc) = retaddr <-> *(retloc -12 + 12) = retaddr <-> *(next->fd + 12) = next->bk`

  Since `next=b`, we choose `b->fd = retloc - 12` and `b->bk = retaddr`
* So we can  return to `retaddr` and execute from there. However the second
  write performed by `unlink()` (`(next->bk + 8) = next->fd`) will overwrite
  `retaddr + 8` too, so we need to go over this value.

 ![payload](/images/heap-overflow-payload.png)

## Use after free
* [An introduction by LiveOverflow](https://www.youtube.com/watch?v=ZHghwsTRyzQ)
* Principle: a pointer is used after it has been freed.
* May reuse previous data
* Protections: isolated heap, delete free
* [A use-after-free example on Windows](https://www.purehacking.com/blog/lloyd-simon/an-introduction-to-use-after-free-vulnerabilities)
* [Use after free POC in Windows](https://cpr-zero.checkpoint.com/vulns/cprid-2129/)

## Heap underflow

## Double free

## Invalid free


## Resources and references
* [Once upon a free() article](http://phrack.org/issues/57/9.html)
* [Heap exploitation tutorial](https://heap-exploitation.dhavalkapil.com/attacks/)
* [Yet another free() exploitation technique](http://phrack.org/issues/66/6.html)
* [Collection of heap exploitation binaries](https://github.com/shellphish/how2heap)
